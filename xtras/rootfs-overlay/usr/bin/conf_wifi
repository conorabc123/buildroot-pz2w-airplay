#!/bin/sh

CONF_FILE="/etc/wpa_supplicant.conf"

# Are we good to start messing with wpa_supplicant.conf? mainly: do we have an ssid/psk in there already?
if ! grep -q 'ssid=' "$CONF_FILE" || ! grep -q 'psk=' "$CONF_FILE"; then
  if ! command -v dialog >/dev/null 2>&1; then
    echo "FATAL: dialog not found. You should never see this!"
    exit 1
  fi

  SSID_TMP="/tmp/ssid.$$"
  PSK_TMP="/tmp/psk.$$"


OLD_LEVEL=$(cat /proc/sys/kernel/printk)
echo 1 > /proc/sys/kernel/printk


  dialog --no-lines --clear --title "Wi-Fi SSID" \
    --inputbox "Enter your Wi-Fi SSID:" 10 40 2> "$SSID_TMP"
  [ $? -ne 0 ] && echo "Cancelled." && exit 1

  dialog --no-lines --clear --title "Wi-Fi Password" \
    --inputbox "Enter Wi-Fi password:" 10 40 2> "$PSK_TMP"
  [ $? -ne 0 ] && echo "Cancelled." && exit 1


echo "$OLD_LEVEL" > /proc/sys/kernel/printk



  SSID="$(cat "$SSID_TMP")"
  PSK="$(cat "$PSK_TMP")"

  rm -f "$SSID_TMP" "$PSK_TMP"

  if [ -z "$SSID" ] || [ -z "$PSK" ]; then
    echo "SSID or password is empty. Aborting."
    exit 1
  fi

  {
    echo "#ctrl_interface=/var/run/wpa_supplicant"
    echo "ap_scan=1"
    echo ""
    echo "network={"
    echo "  ssid=\"$SSID\""
    echo "  psk=\"$PSK\""
    echo "}"
  } > "$CONF_FILE"

  echo "updated  config to $CONF_FILE"
else
  echo "$CONF_FILE already contains an SSID and PSK. Skipping initial WiFi config..."
fi

